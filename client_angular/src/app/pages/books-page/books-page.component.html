<div class="books-page-container">
  <div class="books-page-header">
    <h1>Our Book Collection</h1>
    <div class="header-actions">
      <button *ngIf="isLoggedIn" (click)="toggleAddBookForm()" class="action-button add-book-button">
        {{ showAddBookForm ? 'Cancel' : 'Add New Book' }}
      </button>
      <button (click)="goHome()" class="home-button">Back to Home</button>
      <button *ngIf="isLoggedIn" (click)="logout()" class="action-button logout-button">Logout</button> 
    </div>
  </div>

  <div class="search-container">
    <div class="search-input-group">
      <input type="text" [(ngModel)]="searchTerm" placeholder="Search books..." (keyup.enter)="searchBooks()" class="search-input">
      <button (click)="searchBooks()" class="action-button search-button">Search</button>
    </div>
    <button (click)="resetSearch()" *ngIf="isSearching" class="action-button reset-button">Reset</button>
  </div>

  <!-- Add New Book Form -->
  <div *ngIf="showAddBookForm && isLoggedIn" class="add-book-form-container">
    <h2>Add a New Book</h2>
    <form [formGroup]="addBookForm" (ngSubmit)="onAddBookSubmit()" class="add-book-form">
      <div class="form-group">
        <label for="title">Title</label>
        <input id="title" type="text" formControlName="title" placeholder="Enter book title">
        <div *ngIf="addBookForm.get('title')?.invalid && (addBookForm.get('title')?.dirty || addBookForm.get('title')?.touched)" class="error-message">
          <span *ngIf="addBookForm.get('title')?.errors?.['required']">Title is required.</span>
          <span *ngIf="addBookForm.get('title')?.errors?.['minlength']">Title must be at least 3 characters long.</span>
        </div>
      </div>

      <div class="form-group">
        <label for="author">Author</label>
        <input id="author" type="text" formControlName="author" placeholder="Enter author's name">
        <div *ngIf="addBookForm.get('author')?.invalid && (addBookForm.get('author')?.dirty || addBookForm.get('author')?.touched)" class="error-message">
          <span *ngIf="addBookForm.get('author')?.errors?.['required']">Author is required.</span>
          <span *ngIf="addBookForm.get('author')?.errors?.['minlength']">Author must be at least 3 characters long.</span>
        </div>
      </div>

      <div class="form-group">
        <label for="uploadDate">When did you read?</label>
        <input id="uploadDate" type="date" formControlName="uploadDate">
        <div *ngIf="addBookForm.get('uploadDate')?.invalid && (addBookForm.get('uploadDate')?.dirty || addBookForm.get('uploadDate')?.touched)" class="error-message">
          <span *ngIf="addBookForm.get('uploadDate')?.errors?.['required']">Published Date is required.</span>
        </div>
      </div>

      <div class="form-group">
        <label>Rate the book</label>
        <div class="star-rating">
          <ng-container *ngFor="let star of stars; let i = index">
            <span
              class="star"
              [class.filled]="i < (hoveredStar || addBookForm.get('rank')?.value)"
              (click)="setRank(i + 1)"
              (mouseover)="hoverStars(i + 1)"
              (mouseleave)="hoverStars(0)"
              >&#9733;</span>
          </ng-container>
        </div>
        <div *ngIf="addBookForm.get('rank')?.invalid && (addBookForm.get('rank')?.dirty || addBookForm.get('rank')?.touched)" class="error-message">
          <span *ngIf="addBookForm.get('rank')?.errors?.['required']">Rating is required.</span>
          <span *ngIf="addBookForm.get('rank')?.errors?.['min']">Rating must be at least 1.</span>
          <span *ngIf="addBookForm.get('rank')?.errors?.['max']">Rating cannot exceed 10.</span>
        </div>
      </div>
        
      <div *ngIf="addBookError" class="error-message backend-error">
        {{ addBookError }}
      </div>

      <button type="submit" [disabled]="addBookForm.invalid || isLoading" class="submit-button">
        {{ isLoading ? 'Adding...' : 'Add Book' }}
      </button>
    </form>
  </div>

  <div *ngIf="isLoading && !showAddBookForm" class="loading-indicator">
    <p>Loading books</p> <!-- Removed animated dots from here, CSS handles it -->
  </div>
  <div *ngIf="error && !isLoading" class="error-message-container">
    <p>{{ error }}</p>
    <button (click)="retryFetchBooks()" class="retry-button">Retry</button>
  </div>

  <app-books-list-view *ngIf="!isLoading && !error && books.length > 0" [books]="books"></app-books-list-view>

  <div *ngIf="!isLoading && !error && books.length === 0 && !showAddBookForm" class="no-books-message">
    No books available at the moment. <span *ngIf="isLoggedIn">Try adding one!</span>
  </div>
</div>
